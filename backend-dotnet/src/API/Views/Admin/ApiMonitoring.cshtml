@model API.Middleware.ApiMonitoringData
@{
    ViewData["Title"] = "API İzleme";
}

<div class="py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-activity"></i> API İzleme</h1>
        <form method="post" asp-action="ResetApiStats"
            onsubmit="return confirm('Tüm API istatistikleri sıfırlanacak. Emin misiniz?');">
            <button type="submit" class="btn btn-outline-danger">
                <i class="bi bi-trash"></i> İstatistikleri Sıfırla
            </button>
        </form>
    </div>

    @* Filtreler *@
    <div class="card mb-4">
        <div class="card-header bg-white">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-funnel"></i> Filtreler</h5>
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
                    data-bs-target="#filterCollapse">
                    <i class="bi bi-chevron-down"></i> Aç/Kapat
                </button>
            </div>
        </div>
        <div class="collapse @(ViewBag.Filter?.SearchQuery != null || ViewBag.Filter?.Method != null ? "show" : "")"
            id="filterCollapse">
            <div class="card-body">
                <form method="get" asp-action="ApiMonitoring" id="filterForm">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Endpoint Ara</label>
                            <input type="text" class="form-control" name="SearchQuery"
                                value="@ViewBag.Filter?.SearchQuery" placeholder="/api/...">
                        </div>

                        <div class="col-md-2">
                            <label class="form-label">HTTP Method</label>
                            <select class="form-select" name="Method">
                                <option value="">Tümü</option>
                                <option value="GET" selected="@(ViewBag.Filter?.Method == "GET")">GET</option>
                                <option value="POST" selected="@(ViewBag.Filter?.Method == "POST")">POST</option>
                                <option value="PUT" selected="@(ViewBag.Filter?.Method == "PUT")">PUT</option>
                                <option value="DELETE" selected="@(ViewBag.Filter?.Method == "DELETE")">DELETE</option>
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Yanıt Süresi (ms)</label>
                            <div class="input-group">
                                <input type="number" class="form-control" name="MinResponseTime"
                                    value="@ViewBag.Filter?.MinResponseTime" placeholder="Min">
                                <span class="input-group-text">-</span>
                                <input type="number" class="form-control" name="MaxResponseTime"
                                    value="@ViewBag.Filter?.MaxResponseTime" placeholder="Max">
                            </div>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Hata Oranı (%)</label>
                            <div class="input-group">
                                <input type="number" class="form-control" name="MinErrorRate"
                                    value="@ViewBag.Filter?.MinErrorRate" placeholder="Min" step="0.1">
                                <span class="input-group-text">-</span>
                                <input type="number" class="form-control" name="MaxErrorRate"
                                    value="@ViewBag.Filter?.MaxErrorRate" placeholder="Max" step="0.1">
                            </div>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Min İstek Sayısı</label>
                            <input type="number" class="form-control" name="MinRequests"
                                value="@ViewBag.Filter?.MinRequests" placeholder="En az istek">
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Sırala</label>
                            <select class="form-select" name="SortBy">
                                <option value="TotalRequests"
                                    selected="@(ViewBag.Filter?.SortBy == "TotalRequests" || ViewBag.Filter?.SortBy == null)">
                                    İstek Sayısı</option>
                                <option value="AverageResponseTime"
                                    selected="@(ViewBag.Filter?.SortBy == "AverageResponseTime")">Yanıt Süresi</option>
                                <option value="ErrorRate" selected="@(ViewBag.Filter?.SortBy == "ErrorRate")">Hata Oranı
                                </option>
                                <option value="Endpoint" selected="@(ViewBag.Filter?.SortBy == "Endpoint")">Endpoint
                                </option>
                                <option value="Method" selected="@(ViewBag.Filter?.SortBy == "Method")">Method</option>
                                <option value="LastRequest" selected="@(ViewBag.Filter?.SortBy == "LastRequest")">Son
                                    İstek</option>
                            </select>
                        </div>

                        <div class="col-md-2">
                            <label class="form-label">Sıralama</label>
                            <select class="form-select" name="SortDescending">
                                <option value="true" selected="@(ViewBag.Filter?.SortDescending != false)">Azalan
                                </option>
                                <option value="false" selected="@(ViewBag.Filter?.SortDescending == false)">Artan
                                </option>
                            </select>
                        </div>

                        <div class="col-md-4 d-flex align-items-end gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-search"></i> Filtrele
                            </button>
                            <a href="@Url.Action("ApiMonitoring")" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> Temizle
                            </a>
                        </div>
                    </div>

                    @* Hızlı Filtreler *@
                    <div class="mt-3 pt-3 border-top">
                        <label class="form-label fw-bold">Hızlı Filtreler:</label>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-success" onclick="quickFilter('fast')">
                                <i class="bi bi-lightning-fill"></i> Hızlı (< 100ms) </button>
                                    <button type="button" class="btn btn-outline-warning"
                                        onclick="quickFilter('medium')">
                                        <i class="bi bi-clock"></i> Orta (100-500ms)
                                    </button>
                                    <button type="button" class="btn btn-outline-danger" onclick="quickFilter('slow')">
                                        <i class="bi bi-hourglass"></i> Yavaş (> 500ms)
                                    </button>
                        </div>
                        <div class="btn-group btn-group-sm ms-2" role="group">
                            <button type="button" class="btn btn-outline-danger" onclick="quickFilter('errors')">
                                <i class="bi bi-exclamation-triangle"></i> Hatalı
                            </button>
                            <button type="button" class="btn btn-outline-success" onclick="quickFilter('popular')">
                                <i class="bi bi-graph-up"></i> Popüler (> 10 istek)
                            </button>
                        </div>
                    </div>

                    @if (Model.EndpointStats.Any())
                    {
                        <div class="mt-2">
                            <a href="#endpointTable" class="text-decoration-none">
                                <span class="badge bg-primary">
                                    <i class="bi bi-info-circle"></i> @Model.EndpointStats.Count sonuç bulundu
                                </span>
                            </a>
                        </div>
                    }
                </form>
            </div>
        </div>
    </div>

    @* Özet Kartlar *@
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2 text-white-50">Toplam İstek</h6>
                            <h2 class="card-title mb-0">@Model.TotalRequests.ToString("N0")</h2>
                        </div>
                        <div>
                            <i class="bi bi-arrow-repeat" style="font-size: 3rem; opacity: 0.5;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card text-white bg-danger">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2 text-white-50">Toplam Hata</h6>
                            <h2 class="card-title mb-0">@Model.TotalErrors.ToString("N0")</h2>
                            <small class="text-white-75">@Model.ErrorRate.ToString("F2")% hata oranı</small>
                        </div>
                        <div>
                            <i class="bi bi-exclamation-triangle-fill" style="font-size: 3rem; opacity: 0.5;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2 text-white-50">Ortalama Yanıt Süresi</h6>
                            <h2 class="card-title mb-0">@Model.AverageResponseTime ms</h2>
                        </div>
                        <div>
                            <i class="bi bi-speedometer2" style="font-size: 3rem; opacity: 0.5;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2 text-white-50">Endpoint Sayısı</h6>
                            <h2 class="card-title mb-0">@Model.EndpointStats.Count</h2>
                        </div>
                        <div>
                            <i class="bi bi-diagram-3-fill" style="font-size: 3rem; opacity: 0.5;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @* Grafikler *@
    <div class="row g-4 mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-bar-chart-fill"></i> En Çok Kullanılan Endpoint'ler</h5>
                </div>
                <div class="card-body">
                    <canvas id="endpointChart" height="80"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-pie-chart-fill"></i> Başarı/Hata Oranı</h5>
                </div>
                <div class="card-body">
                    <canvas id="errorRateChart"></canvas>
                    <div class="mt-3 text-center">
                        <div class="d-flex justify-content-around">
                            <div>
                                <span class="badge bg-success">Başarılı: @((Model.TotalRequests -
                                    Model.TotalErrors).ToString("N0"))</span>
                            </div>
                            <div>
                                <span class="badge bg-danger">Hata: @Model.TotalErrors.ToString("N0")</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @* Endpoint İstatistikleri Tablosu *@
    <div class="card mb-4" id="endpointTable">
        <div class="card-header bg-white">
            <h5 class="mb-0">
                <i class="bi bi-list-ul"></i> Endpoint İstatistikleri
                <span class="badge bg-secondary">@Model.EndpointStats.Count endpoint</span>
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Endpoint</th>
                            <th>Method</th>
                            <th>İstek Sayısı</th>
                            <th>Ortalama Süre</th>
                            <th>Min/Max</th>
                            <th>Hata Oranı</th>
                            <th>Başarı Oranı</th>
                            <th>Son İstek</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (!Model.EndpointStats.Any())
                        {
                            <tr>
                                <td colspan="8" class="text-center text-muted py-4">
                                    <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                                    <p class="mt-2">Filtreye uygun endpoint bulunamadı</p>
                                </td>
                            </tr>
                        }
                        @foreach (var stat in Model.EndpointStats)
                        {
                            <tr>
                                <td><code>@stat.Endpoint</code></td>
                                <td>
                                    @switch (stat.Method.ToUpper())
                                    {
                                        case "GET":
                                            <span class="badge bg-success">@stat.Method</span>
                                            break;
                                        case "POST":
                                            <span class="badge bg-primary">@stat.Method</span>
                                            break;
                                        case "PUT":
                                            <span class="badge bg-warning">@stat.Method</span>
                                            break;
                                        case "DELETE":
                                            <span class="badge bg-danger">@stat.Method</span>
                                            break;
                                        default:
                                            <span class="badge bg-secondary">@stat.Method</span>
                                            break;
                                    }
                                </td>
                                <td><strong>@stat.TotalRequests.ToString("N0")</strong></td>
                                <td>
                                    @if (stat.AverageResponseTimeMs < 100)
                                    {
                                        <span class="badge bg-success">@stat.AverageResponseTimeMs ms</span>
                                    }
                                    else if (stat.AverageResponseTimeMs < 500)
                                    {
                                        <span class="badge bg-warning">@stat.AverageResponseTimeMs ms</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-danger">@stat.AverageResponseTimeMs ms</span>
                                    }
                                </td>
                                <td>
                                    <small class="text-muted">@stat.MinResponseTimeMs / @stat.MaxResponseTimeMs ms</small>
                                </td>
                                <td>
                                    @if (stat.ErrorRate > 10)
                                    {
                                        <span class="badge bg-danger">@stat.ErrorRate.ToString("F1")%</span>
                                    }
                                    else if (stat.ErrorRate > 5)
                                    {
                                        <span class="badge bg-warning">@stat.ErrorRate.ToString("F1")%</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success">@stat.ErrorRate.ToString("F1")%</span>
                                    }
                                </td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-success" role="progressbar"
                                            style="width: @stat.SuccessRate.ToString("F0")%">
                                            @stat.SuccessRate.ToString("F0")%
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    @if (stat.LastRequestAt.HasValue)
                                    {
                                        <small class="text-muted">@stat.LastRequestAt.Value.ToString("HH:mm:ss")</small>
                                    }
                                    else
                                    {
                                        <small class="text-muted">-</small>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    @* Son İstekler *@
    <div class="card">
        <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-clock-history"></i> Son İstekler (Son 50)</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Zaman</th>
                            <th>Method</th>
                            <th>Endpoint</th>
                            <th>Status</th>
                            <th>Süre</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var log in Model.RecentRequests)
                        {
                            <tr class="@(log.IsError ? "table-danger" : "")">
                                <td><small>@log.Timestamp.ToString("HH:mm:ss.fff")</small></td>
                                <td>
                                    <span
                                        class="badge badge-sm bg-@(log.Method == "GET" ? "success" : log.Method == "POST" ? "primary" : "warning")">
                                        @log.Method
                                    </span>
                                </td>
                                <td><code class="small">@log.Endpoint</code></td>
                                <td>
                                    @if (log.StatusCode >= 200 && log.StatusCode < 300)
                                    {
                                        <span class="badge bg-success">@log.StatusCode</span>
                                    }
                                    else if (log.StatusCode >= 400 && log.StatusCode < 500)
                                    {
                                        <span class="badge bg-warning">@log.StatusCode</span>
                                    }
                                    else if (log.StatusCode >= 500)
                                    {
                                        <span class="badge bg-danger">@log.StatusCode</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">@log.StatusCode</span>
                                    }
                                </td>
                                <td>
                                    @if (log.ResponseTimeMs < 100)
                                    {
                                        <span class="text-success">@log.ResponseTimeMs ms</span>
                                    }
                                    else if (log.ResponseTimeMs < 500)
                                    {
                                        <span class="text-warning">@log.ResponseTimeMs ms</span>
                                    }
                                    else
                                    {
                                        <span class="text-danger">@log.ResponseTimeMs ms</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Hızlı Filtre Fonksiyonları
        function quickFilter(type) {
            const form = document.getElementById('filterForm');
            const minResponse = form.querySelector('[name="MinResponseTime"]');
            const maxResponse = form.querySelector('[name="MaxResponseTime"]');
            const minError = form.querySelector('[name="MinErrorRate"]');
            const minRequests = form.querySelector('[name="MinRequests"]');

            // Önce tüm filtreleri temizle
            minResponse.value = '';
            maxResponse.value = '';
            minError.value = '';
            minRequests.value = '';

            switch (type) {
                case 'fast':
                    maxResponse.value = '100';
                    break;
                case 'medium':
                    minResponse.value = '100';
                    maxResponse.value = '500';
                    break;
                case 'slow':
                    minResponse.value = '500';
                    break;
                case 'errors':
                    minError.value = '1';
                    break;
                case 'popular':
                    minRequests.value = '10';
                    break;
            }

            form.submit();
        }
    </script>
    <script>
        // En Çok Kullanılan Endpoint'ler - Bar Chart
        const endpointCtx = document.getElementById('endpointChart').getContext('2d');
        const endpointData = @Html.Raw(Json.Serialize(Model.EndpointStats.OrderByDescending(s => s.TotalRequests).Take(10).Select(s => new {
        Endpoint = s.Endpoint.Length > 30 ? s.Endpoint.Substring(0, 30) + "..." : s.Endpoint,
        Count = s.TotalRequests
        })));

        new Chart(endpointCtx, {
            type: 'bar',
            data: {
                labels: endpointData.map(e => e.Endpoint),
                datasets: [{
                    label: 'İstek Sayısı',
                    data: endpointData.map(e => e.Count),
                    backgroundColor: 'rgba(13, 110, 253, 0.8)',
                    borderColor: 'rgb(13, 110, 253)',
                    borderWidth: 2,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        cornerRadius: 8
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1 }
                    }
                }
            }
        });

        // Başarı/Hata Oranı - Donut Chart
        const errorRateCtx = document.getElementById('errorRateChart').getContext('2d');
        new Chart(errorRateCtx, {
            type: 'doughnut',
            data: {
                labels: ['Başarılı', 'Hata'],
                datasets: [{
                    data: [@(Model.TotalRequests - Model.TotalErrors), @Model.TotalErrors],
                    backgroundColor: [
                        'rgba(25, 135, 84, 0.8)',
                        'rgba(220, 53, 69, 0.8)'
                    ],
                    borderColor: [
                        'rgb(25, 135, 84)',
                        'rgb(220, 53, 69)'
                    ],
                    borderWidth: 2,
                    hoverOffset: 15
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: { size: 13 },
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        cornerRadius: 8
                    }
                },
                cutout: '65%'
            }
        });

        // Otomatik yenileme (30 saniyede bir)
        setTimeout(() => {
            location.reload();
        }, 30000);
    </script>
}

